# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem              1.0
PortGroup               github 1.0
PortGroup               cmake 1.1

github.setup            luanti-org luanti 5.12.0
github.tarball_from     archive

revision                0

set game_version        5.8.0

# to add on more files to a github portgroup download
# have to cache the preset distfiles from the github PG
set main_distfile       ${distfiles}

# then add another distfile, with a direct URL as can't use the github PG again
set game_distfile       ${game_version}${extract.suffix}
set game_mastersite     https://github.com/luanti-org/minetest_game/archive/refs/tags

distfiles               ${main_distfile}:main \
                        ${game_distfile}:game

master_sites            ${github.master_sites}:main \
                        ${game_mastersite}:game

checksums               ${main_distfile} \
                        rmd160  d78f85eb69094893ba7265ca7c1d98b39f640e52 \
                        sha256  876867ac874492f20968f2c2eb4e403231e8e9f29e0e06efa512200bd5152355 \
                        size    12557388 \
                        ${game_distfile} \
                        rmd160  9300fde834d5f7e37286225ba0e851e891db2ef1 \
                        sha256  33a3bb43b08497a0bdb2f49f140a2829e582d5c16c0ad52be1595c803f706912 \
                        size    2608281

compiler.cxx_standard   2017
compiler.thread_local_storage   yes

license                 LGPL-2.1+
categories              games

maintainers             {@fvhovell gmail.com:triggered} openmaintainer
description             open source infinite-world block sandbox game with survival and crafting
long_description        ${description} - \
                        Find more Luanti mods at <https://content.luanti.org/> and have fun.

homepage                https://www.luanti.org

depends_build-append    path:bin/doxygen:doxygen \
                        port:gettext

depends_lib-append      path:include/turbojpeg.h:libjpeg-turbo \
                        port:libogg \
                        port:libpng \
                        port:libvorbis \
                        port:freetype \
                        port:leveldb \
                        port:sqlite3 \
                        port:zlib \
                        port:zstd \
                        path:lib/libluajit-5.1.dylib:luajit \
                        port:gmp \
                        port:curl \
                        port:jsoncpp \
                        port:spatialindex \
                        port:libsdl2 \
                        port:xorg-libX11 \
                        port:xorg-libXxf86vm

conflicts               irrlichtmt \
                        minetest

universal_variant       no
supported_archs         arm64 i386 x86_64

# 001. the original build calls fixup_bundle to move all the deps into the app bundle.
#      this doesn't work correctly with macports destrooting, and isn't necessary for a macports install so deleted it
patchfiles-append       001-patch-src-CMakeLists-disable-bundlefixup.diff

# 002. patch to get the luajit include headers ahead of the system includes, or the build finds the
#      wrong lua headers if you have a newer version of lua installed
patchfiles-append       002-patch-cmake-Modules-FindLua-include-LUADIR-before-system.diff

cmake.build_type        Release
cmake.install_prefix    ${applications_dir}

configure.args-append   -D CMAKE_FIND_FRAMEWORK=FIRST \
                        -D BUILD_UNITTESTS=OFF \
                        -D ENABLE_UPDATE_CHECKER=OFF \
                        -D BUILD_CLIENT=ON \
                        -D BUILD_SERVER=ON \
                        -D ENABLE_SOUND=ON \
                        -D USE_SDL2=ON \
                        -D ENABLE_GLES2=OFF \
                        -D ENABLE_OPENGL=ON \
                        -D ENABLE_OPENGL3=ON \
                        -D ENABLE_REDIS=OFF \
                        -D ENABLE_POSTGRESQL=OFF \
                        -D ENABLE_LEVELDB=ON \
                        -D ENABLE_CURL=ON \
                        -D ENABLE_GETTEXT=ON \
                        -D ENABLE_SPATIAL=ON \
                        -D ENABLE_SYSTEM_GMP=ON \
                        -D ENABLE_SYSTEM_JSONCPP=ON \
                        -D ENABLE_LUAJIT=ON \
                        -D INSTALL_DEVTEST=ON \
                        -D VERSION_EXTRA=MacPorts-rev${revision}

post-destroot {
    move ${workpath}/minetest_game-${game_version}   ${destroot}${applications_dir}/${name}.app/Contents/Resources/games/minetest_game
}
